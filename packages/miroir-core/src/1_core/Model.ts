const entitySelfApplication = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/a659d350-dd97-4da9-91de-524fa01745dc.json");
const entitySelfApplicationVersion = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24.json");
const entitySelfApplicationModelBranch = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/cdb0aec6-b848-43ac-a058-fe2dbe5811f1.json");
const entityEntity = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad.json");
// const entitySelfApplicationDeploymentConfiguration = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/35c5608a-7678-4f07-a4ec-76fc5bc35424.json');
const entityEntityDefinition = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd.json");
const entityJzodSchema = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/5e81e1b9-38be-487c-b3e5-53796c57fccf.json");
const entityMenu = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/dde4c883-ae6d-47c3-b6df-26bc6e3c1842.json");
const entityQueryVersion = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/e4320b9e-ab45-4abe-85d8-359604b3c62f.json");
const entityReport = require("../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916.json");
// const entityStoreBasedConfiguration = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/7990c0c9-86c3-40a1-a121-036c91b55ed7.json');

const entityDefinitionJzodSchema = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/15407b85-f2c8-4a34-bfa7-89f044ba2407.json");
const entityDefinitionSelfApplicationVersion = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json");
const entityDefinitionEntity = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/381ab1be-337f-4198-b1d3-f686867fc1dd.json");
const entityDefinitionSelfApplicationModelBranch = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/69bf7c03-a1df-4d1c-88c1-44363feeea87.json");
const entityDefinitionSelfApplication = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/9460420b-f176-4918-bd45-894ab195ffe9.json");
const entityDefinitionMenu = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/0f421b2f-2fdc-47ee-8232-62121ea46350.json");
const entityDefinitionQuery = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/359f1f9b-7260-4d76-a864-72c839b9711b.json");
const entityDefinitionReport = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/952d2c65-4da2-45c2-9394-a0920ceedfb6.json");
const entityDefinitionSelfApplicationDeploymentConfiguration = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bd303ae8-6bce-4b44-a63c-815b9ebf728b.json");
const entityDefinitionEntityDefinition = require("../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bdd7ad43-f0fc-4716-90c1-87454c40dd95.json");
// const entityDefinitionModelVersion = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json');
// const entityDefinitionStoreBasedConfiguration = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/f93af951-ea13-4815-a2e3-ec0cab1fadd2.json');

const menuDefaultMiroir = require("../assets/miroir_data/dde4c883-ae6d-47c3-b6df-26bc6e3c1842/eaac459c-6c2b-475c-8ae4-c6c3032dae00.json");

const reportApplicationVersionList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0810de28-fdab-4baf-8935-7e04a8f779a9.json");
const reportApplicationList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0e4cf674-3a26-422a-8618-09e32302ac0c.json");
const reportConfigurationList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/43f04807-8f96-43f9-876f-9a0210f7b99c.json");
const reportEntityDefinitionDetails = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/acd55b04-84df-427e-b219-cf0e01a6881b.json");
const reportEntityList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/c9ea3359-690c-4620-9603-b5b402e4a2b9.json");
const reportApplicationDeploymentConfigurationList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/df0a9a8f-e0f6-4f9f-8635-c8460e638e1b.json");
const reportEntityDefinitionList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/f9aff35d-8636-4519-8361-c7648e0ddc68.json");
const reportEntityDetails = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/074d1de9-594d-42d6-8848-467baeb6f3e0.json");
const reportMenuList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/ecfd8787-09cc-417d-8d2c-173633c9f998.json");
const reportReportList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/1fc7e12e-90f2-4c0a-8ed9-ed35ce3a7855.json");
const reportApplicationModelBranchList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/60648b22-e2c6-4b74-8031-53884f597d63.json");
const reportJzodSchemaList = require("../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/8b22e84e-9374-4121-b2a7-d13d947a0ba2.json");
const jzodSchemajzodMiroirBootstrapSchema = require("../assets/miroir_data/5e81e1b9-38be-487c-b3e5-53796c57fccf/1e8dab4b-65a3-4686-922e-ce89a2d62aa9.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionEntity = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/17adb534-1dcb-4874-a4ef-6c1e03b31c4e.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionEntityDefinition = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/48644159-66d4-426d-b38d-d083fd455e7b.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionApplicationModelBranch = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/4aaba993-f0a1-4a26-b1ea-13b0ad532685.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionApplicationVersion = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/9086f49a-0e81-4902-81f3-560186dee334.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionStoreBasedConfiguration = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/ba38669e-ac6f-40ea-af14-bb200db251d8.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionApplication = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/dc47438c-166a-4d19-aeba-ad70281afdf4.json");
const applicationVersionInitialMiroirVersionCrossEntityDefinitionReport = require("../assets/miroir_data/8bec933d-6287-4de7-8a88-5c24216de9f4/ede7e794-5ae7-48a8-81c9-d1f82df11829.json");
const selfApplicationVersionInitialMiroirVersion = require("../assets/miroir_data/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24/695826c2-aefa-4f5f-a131-dee46fe21c1.json");
const instanceConfigurationReference = require("../assets/miroir_data/7990c0c9-86c3-40a1-a121-036c91b55ed7/360fcf1f-f0d4-4f8a-9262-07886e70fa15.json");
const adminConfigurationDeploymentMiroir = require("../assets/admin_data/7959d814-400c-4e80-988f-a00fe582ab98/10ff36f2-50a3-48d8-b80f-e48e5d13af8e.json");

// import { entityDefinitionQueryVersionV1, entityQueryVersion } from "..";
// import { entityJzodSchema, entitySelfApplicationDeploymentConfiguration, entityStoreBasedConfiguration } from "..";
import { MetaEntity, Uuid } from "../0_interfaces/1_core/EntityDefinition";
import type { DeploymentUuidToReportsEntitiesDefinitions, DeploymentUuidToReportsEntitiesDefinitionsMapping } from "../0_interfaces/1_core/Model";
import { miroirFundamentalJzodSchema } from "../0_interfaces/1_core/preprocessor-generated/miroirFundamentalJzodSchema";

import {
  Entity,
  EntityDefinition,
  JzodSchema,
  Menu,
  MetaModel,
  Report,
  type ApplicationSection,
} from "../0_interfaces/1_core/preprocessor-generated/miroirFundamentalType";
import type { MiroirModelEnvironment } from "../0_interfaces/1_core/Transformer";

/**
 * TODO: REMOVE THIS, IDEALLY!!! (WAIT, NO, THIS IS OK AS LONG AS IT ALLOWS TO MANAGE DISCREPANCIES BETWEEN 
 * META-APPLICATION AND OTHER APPLICATIONS, AND THIS CONCERNS MAINLY THE META-APPLICATION ITSELF)
 * */
// FIRST: CENTRALIZE LOGIC TO DETERMINE MODEL ENTITIES
export const metaMetaModelEntities: MetaEntity[] = [
  entityEntity,
  entityEntityDefinition,
];
export const metaMetaModelEntityUuids: Uuid[] = metaMetaModelEntities.map((e) => e.uuid);

export const metaModelEntities: MetaEntity[] = [
  entitySelfApplication,
  // entitySelfApplicationDeploymentConfiguration, // TODO: remove, deployments are not part of applications, they are external to them, belonging to a separate selfApplication, which contents is specific to each node (no transactions / historization)
  entitySelfApplicationModelBranch,
  entitySelfApplicationVersion,
  entityEntity, 
  entityEntityDefinition,
  entityMenu,
  entityQueryVersion,
  entityReport,
  // entityStoreBasedConfiguration,
] as MetaEntity[];

export const metaModelEntityUuids: Uuid[] = metaModelEntities.map((e) => e.uuid);
// console.log("metaModelEntities", metaModelEntities)

export const miroirModelEntities: MetaEntity[] = metaModelEntities.filter((e: MetaEntity) => {
  // console.log("filtering metaModelEntities entity", e)
  return e?.conceptLevel == "MetaModel";
});

export const applicationModelEntities: MetaEntity[] = metaModelEntities.filter(
  (e: MetaEntity) => e?.conceptLevel != "MetaModel"
);

// #################################################################################################
export const defaultMiroirMetaModel: MetaModel = {
  // configuration: [instanceConfigurationReference],
  storedQueries: [],
  entities: [
    // this is used in tests, the bootstrap entities have to come first
    entityEntity as Entity,
    entityEntityDefinition as Entity,
    //
    entitySelfApplication as Entity,
    entitySelfApplicationModelBranch as Entity,
    entitySelfApplicationVersion as Entity,
    entityJzodSchema as Entity, // null
    entityMenu as Entity,
    entityQueryVersion as Entity,
    entityReport as Entity,
    entitySelfApplicationVersion as Entity,
  ],
  entityDefinitions: [
    // bootstrap entities have to come first
    entityDefinitionEntityDefinition as EntityDefinition,
    entityDefinitionEntity as EntityDefinition,
    //
    entityDefinitionSelfApplication as EntityDefinition,
    entityDefinitionSelfApplicationModelBranch as EntityDefinition,
    entityDefinitionSelfApplicationVersion as EntityDefinition,
    entityDefinitionJzodSchema as EntityDefinition, //
    entityDefinitionMenu as EntityDefinition,
    entityDefinitionQuery as EntityDefinition,
    entityDefinitionReport as EntityDefinition,
  ],
  jzodSchemas: [jzodSchemajzodMiroirBootstrapSchema as JzodSchema],
  menus: [menuDefaultMiroir as Menu],
  applicationVersions: [selfApplicationVersionInitialMiroirVersion],
  reports: [
    reportApplicationDeploymentConfigurationList as Report,
    reportApplicationList as Report,
    reportApplicationModelBranchList as Report,
    reportApplicationVersionList as Report,
    reportConfigurationList as Report,
    reportEntityDefinitionList as Report,
    reportEntityList as Report,
    reportJzodSchemaList as Report,
    reportMenuList as Report,
    reportReportList as Report,
  ],
  applicationVersionCrossEntityDefinition: [
    applicationVersionInitialMiroirVersionCrossEntityDefinitionApplication,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionApplicationModelBranch,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionApplicationVersion,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionEntity,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionEntityDefinition,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionReport,
    applicationVersionInitialMiroirVersionCrossEntityDefinitionStoreBasedConfiguration,
  ],
};

// #################################################################################################
export const defaultMetaModelEnvironment: MiroirModelEnvironment = {
  miroirFundamentalJzodSchema: miroirFundamentalJzodSchema as JzodSchema,
  miroirMetaModel: defaultMiroirMetaModel,
};
export const defaultMiroirModelEnvironment: MiroirModelEnvironment = {
  deploymentUuid: adminConfigurationDeploymentMiroir.uuid,
  miroirFundamentalJzodSchema: miroirFundamentalJzodSchema as JzodSchema,
  miroirMetaModel: defaultMiroirMetaModel,
  currentModel: defaultMiroirMetaModel,
};

// ################################################################################################
const metaModelReports = [
  reportEntityList.uuid,
  reportEntityDefinitionList.uuid,
  reportEntityDetails.uuid,
  reportEntityDefinitionDetails.uuid,
];

// ################################################################################################
export function getApplicationSection(
  deploymentUuid: Uuid,
  entityUuid: Uuid,
): ApplicationSection{
  if (deploymentUuid == adminConfigurationDeploymentMiroir.uuid) {
    return metaMetaModelEntityUuids.includes(entityUuid)?"model":"data";
  }
  return metaModelEntityUuids.includes(entityUuid)?"model":"data";
}
// ################################################################################################
/**
 * just filters the model / meta-model reports in the Miroir app for now
 * TODO: DEFUNCT? use useCurrentModel only?
 * @param deploymentUuid 
 * @param metaModel 
 * @param appModel 
 * @returns 
 */
export function getReportsAndEntitiesDefinitionsForDeploymentUuid(
  deploymentUuid: Uuid,
  metaModel: MetaModel,
  appModel: MetaModel
): DeploymentUuidToReportsEntitiesDefinitions
// {
//   model: {
//     availableReports: Report[];
//     entities: Entity[];
//     entityDefinitions: EntityDefinition[];
//   };
//   data: {
//     availableReports: Report[];
//     entities: Entity[];
//     entityDefinitions: EntityDefinition[];
//   };
// } 
{
  if (deploymentUuid == adminConfigurationDeploymentMiroir.uuid) {
    return {
      model: {
        availableQueries: metaModel.storedQueries,
        availableReports: metaModel.reports.filter((r:Report) => metaModelReports.includes(r.uuid)),
        entities: metaModel.entities,
        entityDefinitions: metaModel.entityDefinitions,
      },
      data: {
        availableQueries: metaModel.storedQueries,
        availableReports: metaModel.reports.filter((r) => !metaModelReports.includes(r.uuid)),
        entities: metaModel.entities,
        entityDefinitions: metaModel.entityDefinitions,
      },
    };
  } else {
    return {
      model: {
        availableQueries: metaModel.storedQueries,
        availableReports: metaModel.reports,
        entities: metaModel.entities,
        entityDefinitions: metaModel.entityDefinitions,
      },
      data: {
        availableQueries: metaModel.storedQueries,
        availableReports: appModel.reports,
        entities: appModel.entities,
        entityDefinitions: appModel.entityDefinitions,
      },
    };
  }
}
