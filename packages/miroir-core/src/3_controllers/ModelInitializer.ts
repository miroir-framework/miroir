// import entityApplication from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/a659d350-dd97-4da9-91de-524fa01745dc.json';
// import entityApplicationDeploymentConfiguration from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/35c5608a-7678-4f07-a4ec-76fc5bc35424.json';
// import entityApplicationModelBranch from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/cdb0aec6-b848-43ac-a058-fe2dbe5811f1.json';
// import entityApplicationVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24.json';
// import entityApplicationVersionCrossEntityDeployment from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/8bec933d-6287-4de7-8a88-5c24216de9f4.json';
// import entityCommit from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/73bb0c69-e636-4e3b-a230-51f25469c089.json';
// import entityEndpointVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3d8da4d4-8f76-4bb4-9212-14869d81c00c.json';
// import entityEntity from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad.json';
// import entityEntityDefinition from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd.json';
// import entityJzodSchema from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/5e81e1b9-38be-487c-b3e5-53796c57fccf.json';
// import entityReport from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916.json';
// import entityStoreBasedConfiguration from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/7990c0c9-86c3-40a1-a121-036c91b55ed7.json';
// import entityQueryVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/e4320b9e-ab45-4abe-85d8-359604b3c62f.json';

// import entityDefinitionApplication from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/9460420b-f176-4918-bd45-894ab195ffe9.json';
// import entityDefinitionApplicationDeploymentConfiguration from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bd303ae8-6bce-4b44-a63c-815b9ebf728b.json';
// import entityDefinitionApplicationVersion from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json';
// import entityDefinitionApplicationVersionCrossEntityDeployment from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/c0b71083-8cc8-43db-bf52-572f1f03bbb5.json';
// import entityDefinitionApplicationModelBranch from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/69bf7c03-a1df-4d1c-88c1-44363feeea87.json';
// import entityDefinitionCommit from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/b17d5e9e-12f2-4ed8-abdb-2576c01514a4.json';
// import entityDefinitionEndpoint from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/e3c1cc69-066d-4f52-beeb-b659dc7a88b9.json';
// import entityDefinitionEntityDefinition from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bdd7ad43-f0fc-4716-90c1-87454c40dd95.json';
// import entityDefinitionEntity from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/381ab1be-337f-4198-b1d3-f686867fc1dd.json';
// import entityDefinitionJzodSchema from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/15407b85-f2c8-4a34-bfa7-89f044ba2407.json';
// import entityDefinitionReport from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/952d2c65-4da2-45c2-9394-a0920ceedfb6.json';
// import entityDefinitionStoreBasedConfiguration from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/f93af951-ea13-4815-a2e3-ec0cab1fadd2.json';
// import entityDefinitionQuery from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/359f1f9b-7260-4d76-a864-72c839b9711b.json';

// import reportApplicationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0e4cf674-3a26-422a-8618-09e32302ac0c.json';
// import reportApplicationDeploymentConfigurationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/df0a9a8f-e0f6-4f9f-8635-c8460e638e1b.json';
// import reportApplicationModelBranchList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/60648b22-e2c6-4b74-8031-53884f597d63.json';
// import reportApplicationVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0810de28-fdab-4baf-8935-7e04a8f779a9.json';
// import reportCommitList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/7947ae40-eb34-4149-887b-15a9021e714e.json';
// import reportConfigurationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/43f04807-8f96-43f9-876f-9a0210f7b99c.json';
// import reportJzodSchema from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/8b22e84e-9374-4121-b2a7-d13d947a0ba2.json';
// import reportEndpointVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/ace3d5c9-b6a7-43e6-a277-595329e7532a.json';
// import reportEntityList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/c9ea3359-690c-4620-9603-b5b402e4a2b9.json';
// import reportEntityDefinitionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/f9aff35d-8636-4519-8361-c7648e0ddc68.json';
// import reportReportList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/1fc7e12e-90f2-4c0a-8ed9-ed35ce3a7855.json';
// import reportQueryVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/7aed09a9-8a2d-4437-95ab-62966e38352c.json';

// import queryVersionBundleProducerV1 from '../assets/miroir_data/e4320b9e-ab45-4abe-85d8-359604b3c62f/e8c15587-af5d-4c08-b5b7-22f959447690.json';

// import applicationEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ddd9c928-2ceb-4f67-971b-5898090412d6.json';
// import deploymentEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/bbd08cbb-79ff-4539-b91f-7a14f15ac55f.json';
// import instanceEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ed520de4-55a9-4550-ac50-b1b713b72a89.json';
// import modelEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/7947ae40-eb34-4149-887b-15a9021e714e.json';

import { MetaEntity } from "../0_interfaces/1_core/EntityDefinition.js";
import { PersistenceStoreControllerInterface } from '../0_interfaces/4-services/PersistenceStoreControllerInterface.js';
import { DataStoreApplicationType } from '../0_interfaces/3_controllers/ApplicationControllerInterface';
import { LoggerInterface } from '../0_interfaces/4-services/LoggerInterface';
import { MiroirLoggerFactory } from '../4_services/Logger';
import { packageName } from '../constants';
import { getLoggerName } from '../tools';
import { cleanLevel } from './constants';
import { Application, EntityDefinition, EntityInstance, MetaModel } from '../0_interfaces/1_core/preprocessor-generated/miroirFundamentalType';
import {
  applicationEndpointV1,
  deploymentEndpointV1,
  entityApplication,
  entityApplicationDeploymentConfiguration,
  entityApplicationModelBranch,
  entityApplicationVersion,
  entityDefinitionApplication,
  entityDefinitionApplicationDeploymentConfiguration,
  entityDefinitionApplicationModelBranch,
  entityDefinitionApplicationVersion,
  entityDefinitionEndpoint,
  entityDefinitionEntity,
  entityDefinitionEntityDefinition,
  entityDefinitionJzodSchema,
  entityDefinitionMenu,
  entityDefinitionQuery,
  entityDefinitionReport,
  entityDefinitionStoreBasedConfiguration,
  entityEndpointVersion,
  entityEntity,
  entityEntityDefinition,
  entityJzodSchema,
  entityMenu,
  entityQueryVersion,
  entityReport,
  entityStoreBasedConfiguration,
  instanceEndpointV1,
  menuDefaultMiroir,
  modelEndpointV1,
  queryVersionBundleProducerV1,
  reportApplicationDeploymentConfigurationList,
  reportApplicationList,
  reportApplicationModelBranchList,
  reportApplicationVersionList,
  reportConfigurationList,
  reportEndpointVersionList,
  reportEntityDefinitionList,
  reportEntityList,
  reportJzodSchemaList,
  reportMenuList,
  reportQueryVersionList,
  reportReportList,
} from "..";
// import { MiroirModel } from '../0_interfaces/1_core/Model';

const loggerName: string = getLoggerName(packageName, cleanLevel,"ModelInitializer");
let log:LoggerInterface = console as any as LoggerInterface;
MiroirLoggerFactory.asyncCreateLogger(loggerName).then(
  (value: LoggerInterface) => {
    log = value;
  }
);

export const metaModelEntities: MetaEntity[] = [
  entityApplication,
  entityApplicationDeploymentConfiguration, // TODO: remove, deployments are not part of applications, they are external to them, belonging to a separate application, which contents is specific to each node (no transactions / historization)
  entityApplicationModelBranch,
  entityApplicationVersion,
  entityEntity,
  entityEntityDefinition,
  entityReport,
  entityStoreBasedConfiguration,
] as MetaEntity[];

export const miroirModelEntities: MetaEntity[] = metaModelEntities.filter(e=>e.conceptLevel == "MetaModel");

export const applicationModelEntities: MetaEntity[] = metaModelEntities.filter(e=>e.conceptLevel != "MetaModel");

export async function modelInitialize(
  metaModel:MetaModel,
  persistenceStoreController:PersistenceStoreControllerInterface,
  dataStoreType: DataStoreApplicationType,
  application: Application,
  applicationDeploymentConfiguration: EntityInstance,
  applicationModelBranch: EntityInstance,
  applicationVersion: EntityInstance,
  applicationStoreBasedConfiguration: EntityInstance,
): Promise<void> {
  log.info("modelInitialize application",application,'dataStoreType',dataStoreType);
  const logHeader = 'modelInitialize '+ application?.name;
  // TODO: test this.sqlEntities for emptiness, abort if not empty
  // bootstrap MetaClass entity
  log.info('################################### modelInitialize',application.name,'dataStoreType',dataStoreType);
  
  const insertReferenceInMetaModel = dataStoreType == 'miroir';

  if (dataStoreType == 'miroir') {
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition); //entityDefinition for entityEntity has not been inserted!
  
    // bootstrap MetaClass EntityDefinition
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntityDefinition as MetaEntity, entityDefinitionEntityDefinition as EntityDefinition);
    log.info(logHeader, 'created entity EntityDefinition',persistenceStoreController.getEntityUuids());
  
    // // because entityDefinition for entityEntity has not been inserted during datastore.createEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition);!
    await persistenceStoreController.upsertInstance('model', entityEntity as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityEntityDefinition as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityDefinitionEntity as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityDefinitionEntityDefinition as EntityInstance);
    log.info(logHeader, 'created entity entity',persistenceStoreController.getEntityUuids());
  
    // bootstrap Application
    await persistenceStoreController.createEntity(entityApplication as MetaEntity, entityDefinitionApplication as EntityDefinition);
    log.info(logHeader, 'created entity Application',persistenceStoreController.getEntityUuids());
    
    // bootstrap ApplicationModelBranch
    await persistenceStoreController.createEntity(entityApplicationModelBranch as MetaEntity, entityDefinitionApplicationModelBranch as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationModelBranch',persistenceStoreController.getEntityUuids());
    
    // bootstrap ApplicationVersion
    await persistenceStoreController.createEntity(entityApplicationVersion as MetaEntity, entityDefinitionApplicationVersion as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationVersion',persistenceStoreController.getEntityUuids());
    
    // bootstrap Application Deployment Configuration
    await persistenceStoreController.createEntity(entityApplicationDeploymentConfiguration as MetaEntity, entityDefinitionApplicationDeploymentConfiguration as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationDeploymentConfiguration',persistenceStoreController.getEntityUuids());
    
    // // bootstrap Endpoint
    // await persistenceStoreController.createEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    // log.info(logHeader, 'created entity Endpoint',persistenceStoreController.getEntityUuids());
    
    // bootstrap Endpoint version
    await persistenceStoreController.createEntity(entityEndpointVersion as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    log.info(logHeader, 'created entity Endpoint',persistenceStoreController.getEntityUuids());
    
    // bootstrap Menu
    await persistenceStoreController.createEntity(entityMenu as MetaEntity, entityDefinitionMenu as EntityDefinition);
    log.info(logHeader, 'created entity Menu',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityStoreBasedConfiguration
    await persistenceStoreController.createEntity(entityStoreBasedConfiguration as MetaEntity, entityDefinitionStoreBasedConfiguration as EntityDefinition);
    log.info(logHeader, 'created entity StoreBasedConfiguration',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityJzodSchema
    await persistenceStoreController.createEntity(entityJzodSchema as MetaEntity, entityDefinitionJzodSchema as EntityDefinition);
    log.info(logHeader, 'created entity JzodSchema',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityStoreBasedConfiguration
    await persistenceStoreController.createEntity(entityReport as MetaEntity, entityDefinitionReport as EntityDefinition);
    log.info(logHeader, 'created entity EntityReport',persistenceStoreController.getEntityUuids());
    
    // // bootstrap EntityQuery
    // await persistenceStoreController.createEntity(entityQuery as MetaEntity, entityDefinitionQuery as EntityDefinition);
    // log.info(logHeader, 'created entity Query',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityQueryVersion
    await persistenceStoreController.createEntity(entityQueryVersion as MetaEntity, entityDefinitionQuery as EntityDefinition);
    log.info(logHeader, 'created entity Query',persistenceStoreController.getEntityUuids());
    
    await persistenceStoreController.upsertInstance('data', reportConfigurationList as EntityInstance);
    // await persistenceStoreController.upsertInstance('data', reportEndpointList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEndpointVersionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEntityDefinitionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEntityList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationDeploymentConfigurationList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationModelBranchList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationVersionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportMenuList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportReportList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportJzodSchemaList as EntityInstance);
    // await persistenceStoreController.upsertInstance('data', reportQueryList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportQueryVersionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', menuDefaultMiroir as EntityInstance);
    

    await persistenceStoreController.upsertInstance('data', application);
    await persistenceStoreController.upsertInstance('data', applicationDeploymentConfiguration);
    await persistenceStoreController.upsertInstance('data', applicationModelBranch);
    await persistenceStoreController.upsertInstance('data', applicationVersion);
    await persistenceStoreController.upsertInstance('data', applicationStoreBasedConfiguration);

    // await persistenceStoreController.upsertInstance('data', applicationEndpoint);
    await persistenceStoreController.upsertInstance('data', applicationEndpointV1);
    // await persistenceStoreController.upsertInstance('data', deploymentEndpoint);
    await persistenceStoreController.upsertInstance('data', deploymentEndpointV1);
    // await persistenceStoreController.upsertInstance('data', instanceEndpoint);
    await persistenceStoreController.upsertInstance('data', instanceEndpointV1);
    // await persistenceStoreController.upsertInstance('data', modelEndpoint);
    await persistenceStoreController.upsertInstance('data', modelEndpointV1);

    // await persistenceStoreController.upsertInstance('data', queryBundleProducer);
    await persistenceStoreController.upsertInstance('data', queryVersionBundleProducerV1);
  }

  if (dataStoreType == 'app') {
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition); //entityDefinition for entityEntity has not been inserted!
  
    log.info(logHeader, 'app initialized entity Entity',persistenceStoreController.getEntityUuids());

    // bootstrap MetaClass EntityDefinition
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntityDefinition as MetaEntity, entityDefinitionEntityDefinition as EntityDefinition);
    log.info(logHeader, 'app initialized entity Definition',persistenceStoreController.getEntityUuids());

    // bootstrap Application
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityApplication as MetaEntity, entityDefinitionApplication as EntityDefinition);
    log.info(logHeader, 'app initialized entity Application',persistenceStoreController.getEntityUuids());

    // bootstrap ApplicationModelBranch
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityApplicationModelBranch as MetaEntity, entityDefinitionApplicationModelBranch as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationModelBranch',persistenceStoreController.getEntityUuids());

    // bootstrap ApplicationVersion
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityApplicationVersion as MetaEntity, entityDefinitionApplicationVersion as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationVersion',persistenceStoreController.getEntityUuids());

    // bootstrap Application
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityApplicationDeploymentConfiguration as MetaEntity, entityDefinitionApplicationDeploymentConfiguration as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationDeploymentConfiguration',persistenceStoreController.getEntityUuids());

    // // bootstrap Endpoint
    // await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    // log.info(logHeader, 'app initialized entity Endpoint',persistenceStoreController.getEntityUuids());

    // bootstrap Endpoint
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEndpointVersion as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    log.info(logHeader, 'app initialized entity Endpoint',persistenceStoreController.getEntityUuids());

    // bootstrap EntityReport
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityReport as MetaEntity, entityDefinitionReport as EntityDefinition);
    log.info(logHeader, 'app initialized entity Report',persistenceStoreController.getEntityUuids());

    // bootstrap EntityStoreBasedConfiguration
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityStoreBasedConfiguration as MetaEntity, entityDefinitionStoreBasedConfiguration as EntityDefinition);
    log.info(logHeader, 'app initialized entity StoreBasedConfiguration',persistenceStoreController.getEntityUuids());

    await persistenceStoreController.upsertInstance('model', application);
    await persistenceStoreController.upsertInstance('model', applicationDeploymentConfiguration);
    await persistenceStoreController.upsertInstance('model', applicationModelBranch);
    await persistenceStoreController.upsertInstance('model', applicationVersion);
    await persistenceStoreController.upsertInstance('model', applicationStoreBasedConfiguration);
  }


  log.info(logHeader, 'modelInitialize done', JSON.stringify({model: await persistenceStoreController.getModelState(), data: await persistenceStoreController.getDataState()}));
  return Promise.resolve(undefined);
}