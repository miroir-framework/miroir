import entityApplication from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/a659d350-dd97-4da9-91de-524fa01745dc.json';
import entityApplicationDeploymentConfiguration from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/35c5608a-7678-4f07-a4ec-76fc5bc35424.json';
import entityApplicationModelBranch from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/cdb0aec6-b848-43ac-a058-fe2dbe5811f1.json';
import entityApplicationVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24.json';
import entityApplicationVersionCrossEntityDeployment from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/8bec933d-6287-4de7-8a88-5c24216de9f4.json';
import entityCommit from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/73bb0c69-e636-4e3b-a230-51f25469c089.json';
import entityEndpoint from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/757595aa-7e4a-43c0-b561-ae545360ab2d.json';
import entityEndpointVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3d8da4d4-8f76-4bb4-9212-14869d81c00c.json';
import entityEntity from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad.json';
import entityEntityDefinition from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd.json';
import entityJzodSchema from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/5e81e1b9-38be-487c-b3e5-53796c57fccf.json';
import entityReport from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916.json';
import entityStoreBasedConfiguration from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/7990c0c9-86c3-40a1-a121-036c91b55ed7.json';
import entityQuery from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c0ce8936-abf8-492f-80bf-addd6e6b6227.json';
import entityQueryVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/e4320b9e-ab45-4abe-85d8-359604b3c62f.json';
// import entityModelVersion from '../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24.json';

import entityDefinitionApplication from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/9460420b-f176-4918-bd45-894ab195ffe9.json';
import entityDefinitionApplicationDeploymentConfiguration from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bd303ae8-6bce-4b44-a63c-815b9ebf728b.json';
import entityDefinitionApplicationVersion from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json';
import entityDefinitionApplicationVersionCrossEntityDeployment from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/c0b71083-8cc8-43db-bf52-572f1f03bbb5.json';
import entityDefinitionApplicationModelBranch from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/69bf7c03-a1df-4d1c-88c1-44363feeea87.json';
import entityDefinitionCommit from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/b17d5e9e-12f2-4ed8-abdb-2576c01514a4.json';
import entityDefinitionEndpoint from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/6796e19e-8bbd-4b96-b505-76fe49ed5c6a.json';
import entityDefinitionEndpointVersion from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/e3c1cc69-066d-4f52-beeb-b659dc7a88b9.json';
import entityDefinitionEntityDefinition from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bdd7ad43-f0fc-4716-90c1-87454c40dd95.json';
import entityDefinitionEntity from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/381ab1be-337f-4198-b1d3-f686867fc1dd.json';
import entityDefinitionJzodSchema from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/15407b85-f2c8-4a34-bfa7-89f044ba2407.json';
import entityDefinitionReport from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/952d2c65-4da2-45c2-9394-a0920ceedfb6.json';
// import entityDefinitionModelVersion from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json';
import entityDefinitionStoreBasedConfiguration from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/f93af951-ea13-4815-a2e3-ec0cab1fadd2.json';
import entityDefinitionQuery from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/5be645c3-892e-44e3-9358-dfe27c4da74c.json';
import entityDefinitionQueryVersion from '../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/359f1f9b-7260-4d76-a864-72c839b9711b.json';

import reportApplicationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0e4cf674-3a26-422a-8618-09e32302ac0c.json';
import reportApplicationDeploymentConfigurationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/df0a9a8f-e0f6-4f9f-8635-c8460e638e1b.json';
import reportApplicationModelBranchList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/60648b22-e2c6-4b74-8031-53884f597d63.json';
import reportApplicationVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0810de28-fdab-4baf-8935-7e04a8f779a9.json';
import reportCommitList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/7947ae40-eb34-4149-887b-15a9021e714e.json';
import reportConfigurationList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/43f04807-8f96-43f9-876f-9a0210f7b99c.json';
import reportJzodSchema from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/8b22e84e-9374-4121-b2a7-d13d947a0ba2.json';
import reportEndpointList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/362cfe0a-1134-4b77-a0a3-dc69bac94c16.json';
import reportEndpointVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/ace3d5c9-b6a7-43e6-a277-595329e7532a.json';
import reportEntityList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/c9ea3359-690c-4620-9603-b5b402e4a2b9.json';
import reportEntityDefinitionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/f9aff35d-8636-4519-8361-c7648e0ddc68.json';
import reportReportList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/1fc7e12e-90f2-4c0a-8ed9-ed35ce3a7855.json';
import reportQueryList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/62735cfb-e231-4419-a0eb-b19d5701e45a.json';
import reportQueryVersionList from '../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/7aed09a9-8a2d-4437-95ab-62966e38352c.json';

import queryBundleProducer from '../assets/miroir_data/c0ce8936-abf8-492f-80bf-addd6e6b6227/5d7be714-d16d-4e31-97cd-8a27249792ee.json';
import queryVersionBundleProducerV1 from '../assets/miroir_data/e4320b9e-ab45-4abe-85d8-359604b3c62f/e8c15587-af5d-4c08-b5b7-22f959447690.json';

import applicationEndpoint from '../assets/miroir_data/757595aa-7e4a-43c0-b561-ae545360ab2d/a04f7b8a-cdec-4f43-b08c-388f70fdd6ba.json';
import deploymentEndpoint from '../assets/miroir_data/757595aa-7e4a-43c0-b561-ae545360ab2d/b1c4d5d7-56d3-41e2-9574-300d821ecf4c.json';
import instanceEndpoint from '../assets/miroir_data/757595aa-7e4a-43c0-b561-ae545360ab2d/3b31cf8d-5847-4b82-9dbf-22bc5fc9ae99.json';
import modelEndpoint from '../assets/miroir_data/757595aa-7e4a-43c0-b561-ae545360ab2d/45132eed-f0a0-46df-b413-294b1472a46d.json';
import applicationEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ddd9c928-2ceb-4f67-971b-5898090412d6.json';
import deploymentEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/bbd08cbb-79ff-4539-b91f-7a14f15ac55f.json';
import instanceEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ed520de4-55a9-4550-ac50-b1b713b72a89.json';
import modelEndpointV1 from '../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/7947ae40-eb34-4149-887b-15a9021e714e.json';

import { MetaEntity } from "../0_interfaces/1_core/EntityDefinition.js";
import { MiroirApplicationModel } from "../0_interfaces/1_core/Model";
import { Application } from "../0_interfaces/1_core/Application.js";
import { IStoreController } from '../0_interfaces/4-services/StoreControllerInterface.js';
import { DataStoreApplicationType } from '../0_interfaces/3_controllers/ApplicationControllerInterface';
import { LoggerInterface } from '../0_interfaces/4-services/LoggerInterface';
import { MiroirLoggerFactory } from '../4_services/Logger';
import { packageName } from '../constants';
import { getLoggerName } from '../tools';
import { cleanLevel } from './constants';
import { EntityDefinition, EntityInstance } from '../0_interfaces/1_core/preprocessor-generated/miroirFundamentalType';

const loggerName: string = getLoggerName(packageName, cleanLevel,"ModelInitializer");
let log:LoggerInterface = console as any as LoggerInterface;
MiroirLoggerFactory.asyncCreateLogger(loggerName).then(
  (value: LoggerInterface) => {
    log = value;
  }
);

export const metaModelEntities: MetaEntity[] = [
  entityApplication,
  entityApplicationDeploymentConfiguration, // TODO: remove, deployments are not part of applications, they are external to them, belonging to a separate application, which contents is specific to each node (no transactions / historization)
  entityApplicationModelBranch,
  entityApplicationVersion,
  entityEntity,
  entityEntityDefinition,
  entityReport,
  entityStoreBasedConfiguration,
] as MetaEntity[];

export const miroirModelEntities: MetaEntity[] = metaModelEntities.filter(e=>e.conceptLevel == "MetaModel");

export const applicationModelEntities: MetaEntity[] = metaModelEntities.filter(e=>e.conceptLevel != "MetaModel");

export async function modelInitialize(
  metaModel:MiroirApplicationModel,
  storeController:IStoreController,
  dataStoreType: DataStoreApplicationType,
  application: Application,
  applicationDeploymentConfiguration: EntityInstance,
  applicationModelBranch: EntityInstance,
  applicationVersion: EntityInstance,
  applicationStoreBasedConfiguration: EntityInstance,
): Promise<void> {
  log.info("modelInitialize application",application,'dataStoreType',dataStoreType);
  const logHeader = 'modelInitialize '+ application?.name;
  // TODO: test this.sqlEntities for emptiness, abort if not empty
  // bootstrap MetaClass entity
  log.info('################################### modelInitialize',application.name,'dataStoreType',dataStoreType);
  
  const insertReferenceInMetaModel = dataStoreType == 'miroir';

  if (dataStoreType == 'miroir') {
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition); //entityDefinition for entityEntity has not been inserted!
  
    // bootstrap MetaClass EntityDefinition
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEntityDefinition as MetaEntity, entityDefinitionEntityDefinition as EntityDefinition);
    log.info(logHeader, 'created entity EntityDefinition',storeController.getEntityUuids());
  
    // // because entityDefinition for entityEntity has not been inserted during datastore.createEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition);!
    await storeController.upsertInstance('model', entityEntity as EntityInstance);
    await storeController.upsertInstance('model', entityEntityDefinition as EntityInstance);
    await storeController.upsertInstance('model', entityDefinitionEntity as EntityInstance);
    await storeController.upsertInstance('model', entityDefinitionEntityDefinition as EntityInstance);
    log.info(logHeader, 'created entity entity',storeController.getEntityUuids());
  
    // bootstrap Application
    await storeController.createEntity(entityApplication as MetaEntity, entityDefinitionApplication as EntityDefinition);
    log.info(logHeader, 'created entity Application',storeController.getEntityUuids());
    
    // bootstrap ApplicationModelBranch
    await storeController.createEntity(entityApplicationModelBranch as MetaEntity, entityDefinitionApplicationModelBranch as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationModelBranch',storeController.getEntityUuids());
    
    // bootstrap ApplicationVersion
    await storeController.createEntity(entityApplicationVersion as MetaEntity, entityDefinitionApplicationVersion as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationVersion',storeController.getEntityUuids());
    
    // bootstrap Application Deployment Configuration
    await storeController.createEntity(entityApplicationDeploymentConfiguration as MetaEntity, entityDefinitionApplicationDeploymentConfiguration as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationDeploymentConfiguration',storeController.getEntityUuids());
    
    // bootstrap Endpoint
    await storeController.createEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    log.info(logHeader, 'created entity Endpoint',storeController.getEntityUuids());
    
    // bootstrap Endpoint version
    await storeController.createEntity(entityEndpointVersion as MetaEntity, entityDefinitionEndpointVersion as EntityDefinition);
    log.info(logHeader, 'created entity EndpointVersion',storeController.getEntityUuids());
    
    // bootstrap EntityStoreBasedConfiguration
    await storeController.createEntity(entityStoreBasedConfiguration as MetaEntity, entityDefinitionStoreBasedConfiguration as EntityDefinition);
    log.info(logHeader, 'created entity StoreBasedConfiguration',storeController.getEntityUuids());
    
    // bootstrap EntityJzodSchema
    await storeController.createEntity(entityJzodSchema as MetaEntity, entityDefinitionJzodSchema as EntityDefinition);
    log.info(logHeader, 'created entity JzodSchema',storeController.getEntityUuids());
    
    // bootstrap EntityStoreBasedConfiguration
    await storeController.createEntity(entityReport as MetaEntity, entityDefinitionReport as EntityDefinition);
    log.info(logHeader, 'created entity EntityReport',storeController.getEntityUuids());
    
    // bootstrap EntityQuery
    await storeController.createEntity(entityQuery as MetaEntity, entityDefinitionQuery as EntityDefinition);
    log.info(logHeader, 'created entity Query',storeController.getEntityUuids());
    
    // bootstrap EntityQueryVersion
    await storeController.createEntity(entityQueryVersion as MetaEntity, entityDefinitionQueryVersion as EntityDefinition);
    log.info(logHeader, 'created entity QueryVersion',storeController.getEntityUuids());
    
    await storeController.upsertInstance('data', reportConfigurationList as EntityInstance);
    await storeController.upsertInstance('data', reportEndpointList as EntityInstance);
    await storeController.upsertInstance('data', reportEndpointVersionList as EntityInstance);
    await storeController.upsertInstance('data', reportEntityDefinitionList as EntityInstance);
    await storeController.upsertInstance('data', reportEntityList as EntityInstance);
    await storeController.upsertInstance('data', reportApplicationList as EntityInstance);
    await storeController.upsertInstance('data', reportApplicationDeploymentConfigurationList as EntityInstance);
    await storeController.upsertInstance('data', reportApplicationModelBranchList as EntityInstance);
    await storeController.upsertInstance('data', reportApplicationVersionList as EntityInstance);
    await storeController.upsertInstance('data', reportReportList as EntityInstance);
    await storeController.upsertInstance('data', reportJzodSchema as EntityInstance);
    await storeController.upsertInstance('data', reportQueryList as EntityInstance);
    await storeController.upsertInstance('data', reportQueryVersionList as EntityInstance);
    

    await storeController.upsertInstance('data', application);
    await storeController.upsertInstance('data', applicationDeploymentConfiguration);
    await storeController.upsertInstance('data', applicationModelBranch);
    await storeController.upsertInstance('data', applicationVersion);
    await storeController.upsertInstance('data', applicationStoreBasedConfiguration);

    await storeController.upsertInstance('data', applicationEndpoint);
    await storeController.upsertInstance('data', applicationEndpointV1);
    await storeController.upsertInstance('data', deploymentEndpoint);
    await storeController.upsertInstance('data', deploymentEndpointV1);
    await storeController.upsertInstance('data', instanceEndpoint);
    await storeController.upsertInstance('data', instanceEndpointV1);
    await storeController.upsertInstance('data', modelEndpoint);
    await storeController.upsertInstance('data', modelEndpointV1);

    await storeController.upsertInstance('data', queryBundleProducer);
    await storeController.upsertInstance('data', queryVersionBundleProducerV1);
  }

  if (dataStoreType == 'app') {
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition); //entityDefinition for entityEntity has not been inserted!
  
    log.info(logHeader, 'app initialized entity Entity',storeController.getEntityUuids());

    // bootstrap MetaClass EntityDefinition
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEntityDefinition as MetaEntity, entityDefinitionEntityDefinition as EntityDefinition);
    log.info(logHeader, 'app initialized entity Definition',storeController.getEntityUuids());

    // bootstrap Application
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityApplication as MetaEntity, entityDefinitionApplication as EntityDefinition);
    log.info(logHeader, 'app initialized entity Application',storeController.getEntityUuids());

    // bootstrap ApplicationModelBranch
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityApplicationModelBranch as MetaEntity, entityDefinitionApplicationModelBranch as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationModelBranch',storeController.getEntityUuids());

    // bootstrap ApplicationVersion
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityApplicationVersion as MetaEntity, entityDefinitionApplicationVersion as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationVersion',storeController.getEntityUuids());

    // bootstrap Application
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityApplicationDeploymentConfiguration as MetaEntity, entityDefinitionApplicationDeploymentConfiguration as EntityDefinition);
    log.info(logHeader, 'app initialized entity ApplicationDeploymentConfiguration',storeController.getEntityUuids());

    // bootstrap Endpoint
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    log.info(logHeader, 'app initialized entity Endpoint',storeController.getEntityUuids());

    // bootstrap EndpointVersion
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityEndpointVersion as MetaEntity, entityDefinitionEndpointVersion as EntityDefinition);
    log.info(logHeader, 'app initialized entity EndpointVersion',storeController.getEntityUuids());

    // bootstrap EntityReport
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityReport as MetaEntity, entityDefinitionReport as EntityDefinition);
    log.info(logHeader, 'app initialized entity Report',storeController.getEntityUuids());

    // bootstrap EntityStoreBasedConfiguration
    await storeController.createModelStorageSpaceForInstancesOfEntity(entityStoreBasedConfiguration as MetaEntity, entityDefinitionStoreBasedConfiguration as EntityDefinition);
    log.info(logHeader, 'app initialized entity StoreBasedConfiguration',storeController.getEntityUuids());

    await storeController.upsertInstance('model', application);
    await storeController.upsertInstance('model', applicationDeploymentConfiguration);
    await storeController.upsertInstance('model', applicationModelBranch);
    await storeController.upsertInstance('model', applicationVersion);
    await storeController.upsertInstance('model', applicationStoreBasedConfiguration);
  }


  log.info(logHeader, 'modelInitialize done', JSON.stringify({model: await storeController.getModelState(), data: await storeController.getDataState()}));
  return Promise.resolve(undefined);
}