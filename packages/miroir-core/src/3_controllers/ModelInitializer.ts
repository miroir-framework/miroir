const entityEntity = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad.json');
const entitySelfApplicationDeploymentConfiguration = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/35c5608a-7678-4f07-a4ec-76fc5bc35424.json');
const entityEndpointVersion = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3d8da4d4-8f76-4bb4-9212-14869d81c00c.json');
const entityReport = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916.json');
const entityEntityDefinition = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd.json');
const entityJzodSchema = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/5e81e1b9-38be-487c-b3e5-53796c57fccf.json');
const entityStoreBasedConfiguration = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/7990c0c9-86c3-40a1-a121-036c91b55ed7.json');
const entitySelfApplication = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/a659d350-dd97-4da9-91de-524fa01745dc.json');
const entitySelfApplicationVersion = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/c3f0facf-57d1-4fa8-b3fa-f2c007fdbe24.json');
const entitySelfApplicationModelBranch = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/cdb0aec6-b848-43ac-a058-fe2dbe5811f1.json');
const entityMenu = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/dde4c883-ae6d-47c3-b6df-26bc6e3c1842.json');
const entityQueryVersion = require('../assets/miroir_model/16dbfe28-e1d7-4f20-9ba4-c1a9873202ad/e4320b9e-ab45-4abe-85d8-359604b3c62f.json');

const entityDefinitionMenu = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/0f421b2f-2fdc-47ee-8232-62121ea46350.json');
const entityDefinitionJzodSchema = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/15407b85-f2c8-4a34-bfa7-89f044ba2407.json');
const entityDefinitionSelfApplicationVersion = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/27046fce-742f-4cc4-bb95-76b271f490a5.json');
const entityDefinitionQuery = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/359f1f9b-7260-4d76-a864-72c839b9711b.json');
const entityDefinitionEntity = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/381ab1be-337f-4198-b1d3-f686867fc1dd.json');
const entityDefinitionSelfApplicationModelBranch = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/69bf7c03-a1df-4d1c-88c1-44363feeea87.json');
const entityDefinitionSelfApplication = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/9460420b-f176-4918-bd45-894ab195ffe9.json');
const entityDefinitionReport = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/952d2c65-4da2-45c2-9394-a0920ceedfb6.json');
const entityDefinitionSelfApplicationDeploymentConfiguration = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bd303ae8-6bce-4b44-a63c-815b9ebf728b.json');
const entityDefinitionEntityDefinition = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/bdd7ad43-f0fc-4716-90c1-87454c40dd95.json');
const entityDefinitionEndpoint = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/e3c1cc69-066d-4f52-beeb-b659dc7a88b9.json');
const entityDefinitionStoreBasedConfiguration = require('../assets/miroir_model/54b9c72f-d4f3-4db9-9e0e-0dc840b530bd/f93af951-ea13-4815-a2e3-ec0cab1fadd2.json');

const reportApplicationVersionList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0810de28-fdab-4baf-8935-7e04a8f779a9.json');
const reportApplicationList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/0e4cf674-3a26-422a-8618-09e32302ac0c.json');
const reportReportList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/1fc7e12e-90f2-4c0a-8ed9-ed35ce3a7855.json');
const reportConfigurationList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/43f04807-8f96-43f9-876f-9a0210f7b99c.json');
const reportApplicationModelBranchList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/60648b22-e2c6-4b74-8031-53884f597d63.json');
const reportQueryList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/7aed09a9-8a2d-4437-95ab-62966e38352c.json');
const reportJzodSchemaList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/8b22e84e-9374-4121-b2a7-d13d947a0ba2.json');
const reportEndpointVersionList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/ace3d5c9-b6a7-43e6-a277-595329e7532a.json');
const reportEntityList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/c9ea3359-690c-4620-9603-b5b402e4a2b9.json');
const reportApplicationDeploymentConfigurationList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/df0a9a8f-e0f6-4f9f-8635-c8460e638e1b.json');
const reportMenuList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/ecfd8787-09cc-417d-8d2c-173633c9f998.json');
const reportEntityDefinitionList = require('../assets/miroir_data/3f2baa83-3ef7-45ce-82ea-6a43f7a8c916/f9aff35d-8636-4519-8361-c7648e0ddc68.json');

const queryVersionBundleProducerV1 = require('../assets/miroir_data/e4320b9e-ab45-4abe-85d8-359604b3c62f/e8c15587-af5d-4c08-b5b7-22f959447690.json');

const modelEndpointV1 = require('../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/7947ae40-eb34-4149-887b-15a9021e714e.json');
const deploymentEndpointV1 = require('../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/bbd08cbb-79ff-4539-b91f-7a14f15ac55f.json');
const applicationEndpointV1 = require('../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ddd9c928-2ceb-4f67-971b-5898090412d6.json');
const instanceEndpointV1 = require('../assets/miroir_data/3d8da4d4-8f76-4bb4-9212-14869d81c00c/ed520de4-55a9-4550-ac50-b1b713b72a89.json');

const miroirJzodSchemaBootstrap = require('../assets/miroir_data/5e81e1b9-38be-487c-b3e5-53796c57fccf/1e8dab4b-65a3-4686-922e-ce89a2d62aa9.json');
const menuDefaultMiroir = require('../assets/miroir_data/dde4c883-ae6d-47c3-b6df-26bc6e3c1842/eaac459c-6c2b-475c-8ae4-c6c3032dae00.json');
const menuDefaultLibrary = require("../assets/library_model/dde4c883-ae6d-47c3-b6df-26bc6e3c1842/dd168e5a-2a21-4d2d-a443-032c6d15eb22.json");

import { MetaEntity } from "../0_interfaces/1_core/EntityDefinition";
import {
  EntityDefinition,
  EntityInstance,
  MetaModel,
  SelfApplication,
  SelfApplicationDeploymentConfiguration,
} from "../0_interfaces/1_core/preprocessor-generated/miroirFundamentalType";
import { DataStoreApplicationType } from '../0_interfaces/3_controllers/ApplicationControllerInterface.js';
import { LoggerInterface } from '../0_interfaces/4-services/LoggerInterface.js';
import { PersistenceStoreControllerInterface } from '../0_interfaces/4-services/PersistenceStoreControllerInterface.js';
import { MiroirLoggerFactory } from '../4_services/LoggerFactory.js';
import { packageName } from '../constants.js';
import { cleanLevel } from './constants.js';

let log: LoggerInterface = console as any as LoggerInterface;
MiroirLoggerFactory.registerLoggerToStart(
  MiroirLoggerFactory.getLoggerName(packageName, cleanLevel, "ModelInitializer")
).then((logger: LoggerInterface) => {log = logger});



export async function modelInitialize(
  metaModel:MetaModel,
  persistenceStoreController:PersistenceStoreControllerInterface,
  dataStoreType: DataStoreApplicationType,
  selfApplication: SelfApplication,
  selfApplicationModelBranch: EntityInstance,
  selfApplicationVersion: EntityInstance,
  // selfApplicationStoreBasedConfiguration: EntityInstance,
): Promise<void> {
  log.info("modelInitialize selfApplication",selfApplication,'dataStoreType',dataStoreType);
  const logHeader = 'modelInitialize '+ selfApplication?.name;
  // TODO: test this.sqlEntities for emptiness, abort if not empty
  // bootstrap MetaClass entity
  log.info('################################### modelInitialize',selfApplication.name,'dataStoreType',dataStoreType);
  
  const insertReferenceInMetaModel = dataStoreType == 'miroir';

  if (dataStoreType == 'miroir') {
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition); //entityDefinition for entityEntity has not been inserted!
  
    // bootstrap MetaClass EntityDefinition
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEntityDefinition as MetaEntity, entityDefinitionEntityDefinition as EntityDefinition);
    log.info(logHeader, 'created entity EntityDefinition',persistenceStoreController.getEntityUuids());
  
    // // because entityDefinition for entityEntity has not been inserted during datastore.createEntity(entityEntity as MetaEntity,entityDefinitionEntity as EntityDefinition);!
    await persistenceStoreController.upsertInstance('model', entityEntity as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityEntityDefinition as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityDefinitionEntity as EntityInstance);
    await persistenceStoreController.upsertInstance('model', entityDefinitionEntityDefinition as EntityInstance);
    log.info(logHeader, 'created entity entity',persistenceStoreController.getEntityUuids());
  
    // bootstrap SelfApplication
    await persistenceStoreController.createEntity(entitySelfApplication as MetaEntity, entityDefinitionSelfApplication as EntityDefinition);
    log.info(logHeader, 'created entity SelfApplication',persistenceStoreController.getEntityUuids());
    
    // bootstrap ApplicationModelBranch
    await persistenceStoreController.createEntity(entitySelfApplicationModelBranch as MetaEntity, entityDefinitionSelfApplicationModelBranch as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationModelBranch',persistenceStoreController.getEntityUuids());
    
    // bootstrap ApplicationVersion
    await persistenceStoreController.createEntity(entitySelfApplicationVersion as MetaEntity, entityDefinitionSelfApplicationVersion as EntityDefinition);
    log.info(logHeader, 'created entity ApplicationVersion',persistenceStoreController.getEntityUuids());
    
    // // bootstrap SelfApplication Deployment Configuration
    // await persistenceStoreController.createEntity(entitySelfApplicationDeploymentConfiguration as MetaEntity, entityDefinitionSelfApplicationDeploymentConfiguration as EntityDefinition);
    // log.info(logHeader, 'created entity entitySelfApplicationDeploymentConfiguration',persistenceStoreController.getEntityUuids());

    


    // // bootstrap Endpoint
    // await persistenceStoreController.createEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    // log.info(logHeader, 'created entity Endpoint',persistenceStoreController.getEntityUuids());
    
    // bootstrap Endpoint version
    await persistenceStoreController.createEntity(entityEndpointVersion as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    log.info(logHeader, 'created entity Endpoint',persistenceStoreController.getEntityUuids());
    
    // bootstrap Menu
    await persistenceStoreController.createEntity(entityMenu as MetaEntity, entityDefinitionMenu as EntityDefinition);
    log.info(logHeader, 'created entity Menu',persistenceStoreController.getEntityUuids());
    
    // // bootstrap EntityStoreBasedConfiguration
    // await persistenceStoreController.createEntity(entityStoreBasedConfiguration as MetaEntity, entityDefinitionStoreBasedConfiguration as EntityDefinition);
    // log.info(logHeader, 'created entity StoreBasedConfiguration',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityJzodSchema
    await persistenceStoreController.createEntity(entityJzodSchema as MetaEntity, entityDefinitionJzodSchema as EntityDefinition);
    log.info(logHeader, 'created entity JzodSchema',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityStoreBasedConfiguration
    await persistenceStoreController.createEntity(entityReport as MetaEntity, entityDefinitionReport as EntityDefinition);
    log.info(logHeader, 'created entity EntityReport',persistenceStoreController.getEntityUuids());
    
    // // bootstrap EntityQuery
    // await persistenceStoreController.createEntity(entityQuery as MetaEntity, entityDefinitionQuery as EntityDefinition);
    // log.info(logHeader, 'created entity Query',persistenceStoreController.getEntityUuids());
    
    // bootstrap EntityQueryVersion
    await persistenceStoreController.createEntity(entityQueryVersion as MetaEntity, entityDefinitionQuery as EntityDefinition);
    log.info(logHeader, 'created entity Query',persistenceStoreController.getEntityUuids());
    
    await persistenceStoreController.upsertInstance('data', reportConfigurationList as EntityInstance);
    // await persistenceStoreController.upsertInstance('data', reportEndpointList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEndpointVersionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEntityDefinitionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportEntityList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationDeploymentConfigurationList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationModelBranchList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportApplicationVersionList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportMenuList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportReportList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportJzodSchemaList as EntityInstance);
    // await persistenceStoreController.upsertInstance('data', reportQueryList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', reportQueryList as EntityInstance);
    await persistenceStoreController.upsertInstance('data', menuDefaultMiroir as EntityInstance);
    await persistenceStoreController.upsertInstance('data', miroirJzodSchemaBootstrap as EntityInstance);
    

    await persistenceStoreController.upsertInstance('data', selfApplication);
    // log.info(logHeader, 'inserting miroir selfApplicationDeploymentConfiguration',selfApplicationDeploymentConfiguration);
    // await persistenceStoreController.upsertInstance('data', selfApplicationDeploymentConfiguration);
    // log.info(logHeader, 'inserting miroir selfApplicationDeploymentConfiguration DONE');
    await persistenceStoreController.upsertInstance('data', selfApplicationModelBranch);
    await persistenceStoreController.upsertInstance('data', selfApplicationVersion);
    // await persistenceStoreController.upsertInstance('data', selfApplicationStoreBasedConfiguration);

    // await persistenceStoreController.upsertInstance('data', applicationEndpoint);
    await persistenceStoreController.upsertInstance('data', applicationEndpointV1);
    // await persistenceStoreController.upsertInstance('data', deploymentEndpoint);
    await persistenceStoreController.upsertInstance('data', deploymentEndpointV1);
    // await persistenceStoreController.upsertInstance('data', instanceEndpoint);
    await persistenceStoreController.upsertInstance('data', instanceEndpointV1);
    // await persistenceStoreController.upsertInstance('data', modelEndpoint);
    await persistenceStoreController.upsertInstance('data', modelEndpointV1);

    // await persistenceStoreController.upsertInstance('data', queryBundleProducer);
    await persistenceStoreController.upsertInstance('data', queryVersionBundleProducerV1);
  }

  if (dataStoreType == 'app') {
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entityEntity as MetaEntity,
      entityDefinitionEntity as EntityDefinition
    ); //entityDefinition for entityEntity has not been inserted!

    log.info(logHeader, "app initialized entity Entity", persistenceStoreController.getEntityUuids());

    // bootstrap MetaClass EntityDefinition
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entityEntityDefinition as MetaEntity,
      entityDefinitionEntityDefinition as EntityDefinition
    );
    log.info(logHeader, "app initialized entity Definition", persistenceStoreController.getEntityUuids());

    // bootstrap Self SelfApplication
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entitySelfApplication as MetaEntity,
      entityDefinitionSelfApplication as EntityDefinition
    );
    log.info(logHeader, "app initialized entity SelfApplication", persistenceStoreController.getEntityUuids());

    // bootstrap Self ApplicationModelBranch
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entitySelfApplicationModelBranch as MetaEntity,
      entityDefinitionSelfApplicationModelBranch as EntityDefinition
    );
    log.info(logHeader, "app initialized entity ApplicationModelBranch", persistenceStoreController.getEntityUuids());

    // bootstrap Self ApplicationVersion
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entitySelfApplicationVersion as MetaEntity,
      entityDefinitionSelfApplicationVersion as EntityDefinition
    );
    log.info(logHeader, "app initialized entity ApplicationVersion", persistenceStoreController.getEntityUuids());

    // bootstrap Self Deployment
    // await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
    //   entitySelfApplicationDeploymentConfiguration as MetaEntity,
    //   entityDefinitionSelfApplicationDeploymentConfiguration as EntityDefinition
    // );
    // log.info(
    //   logHeader,
    //   "app initialized entity selfApplicationDeploymentConfiguration",
    //   persistenceStoreController.getEntityUuids()
    // );

    // bootstrap Self Menu
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entityMenu as MetaEntity,
      entityDefinitionMenu as EntityDefinition
    );
    log.info(
      logHeader,
      "app initialized entity Menu",
      persistenceStoreController.getEntityUuids()
    );

    // // bootstrap Endpoint
    // await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(entityEndpoint as MetaEntity, entityDefinitionEndpoint as EntityDefinition);
    // log.info(logHeader, 'app initialized entity Endpoint',persistenceStoreController.getEntityUuids());

    // bootstrap Endpoint
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entityEndpointVersion as MetaEntity,
      entityDefinitionEndpoint as EntityDefinition
    );
    log.info(logHeader, "app initialized entity Endpoint", persistenceStoreController.getEntityUuids());

    // bootstrap EntityReport
    await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
      entityReport as MetaEntity,
      entityDefinitionReport as EntityDefinition
    );
    log.info(logHeader, "app initialized entity Report", persistenceStoreController.getEntityUuids());

    // // bootstrap EntityStoreBasedConfiguration
    // await persistenceStoreController.createModelStorageSpaceForInstancesOfEntity(
    //   entityStoreBasedConfiguration as MetaEntity,
    //   entityDefinitionStoreBasedConfiguration as EntityDefinition
    // );
    // log.info(logHeader, "app initialized entity StoreBasedConfiguration", persistenceStoreController.getEntityUuids());

    await persistenceStoreController.upsertInstance("model", selfApplication);
    // // log.info(logHeader, 'inserting app selfApplicationDeploymentConfiguration',selfApplicationDeploymentConfiguration);
    // await persistenceStoreController.upsertInstance("model", selfApplicationDeploymentConfiguration);
    // // log.info(logHeader, 'inserting app selfApplicationDeploymentConfiguration DONE');
    await persistenceStoreController.upsertInstance("model", selfApplicationModelBranch);
    await persistenceStoreController.upsertInstance("model", selfApplicationVersion);
    // await persistenceStoreController.upsertInstance("model", selfApplicationStoreBasedConfiguration);
    await persistenceStoreController.upsertInstance("model", menuDefaultLibrary);
  }

  // HUGE LOG!
  // log.info(
  //   logHeader,
  //   "modelInitialize done",
  //   JSON.stringify({
  //     model: await persistenceStoreController.getModelState(),
  //     data: await persistenceStoreController.getDataState(),
  //   })
  // );
  return Promise.resolve(undefined);
}