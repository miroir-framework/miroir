# HTTPS Architecture Reference

This document describes the design decisions behind the Miroir HTTPS migration.

---

## Overview

Both development servers share a single pair of locally-trusted TLS certificates:

```
<repo-root>/
  certs/               ← gitignored; generated by scripts/setup-https.sh/.ps1
    localhost.pem      ← TLS certificate (CA-signed by mkcert local CA)
    localhost-key.pem  ← Private key

  packages/
    miroir-server/     ← Express HTTPS server, port 3080
    miroir-standalone-app/  ← Vite dev server (HTTPS), port 5173
    miroir-standalone-app-electron/  ← Electron (dev: loads https://localhost:5173)
```

---

## Certificate strategy: mkcert local CA

[mkcert](https://github.com/FiloSottile/mkcert) generates certificates signed by a local root CA that it installs into the OS/browser certificate trust store.

**Why mkcert over self-signed certs?**
- Certificates are trusted **automatically** by Chrome, Firefox, Safari, and Electron without any browser exception or `--ignore-certificate-errors` flag.
- Single one-time install command (`mkcert -install`) covers all browsers and Electron on that machine.
- Certs can be regenerated at any time with no side-effects.

**Trust chain for each consumer:**

| Consumer | Trust mechanism |
|---|---|
| Chrome / Firefox / Safari | mkcert root CA added to OS certificate store by `mkcert -install` |
| Electron (Chromium) | Same OS certificate store |
| Node.js (test runner, server internal calls) | `NODE_EXTRA_CA_CERTS` env var pointing to mkcert's `rootCA.pem` |
| curl in scripts | `-k` flag (insecure, only used in localhost health-check scripts) |

**Why `NODE_EXTRA_CA_CERTS` for Node.js?**  
Node.js does **not** read the OS trust store.  It bundles its own CA list (compiled from Mozilla's CA bundle).  Setting `NODE_EXTRA_CA_CERTS` to the mkcert root CA PEM appends it to Node's list at startup, without disabling TLS verification (`NODE_TLS_REJECT_UNAUTHORIZED=0`).

---

## Shared `certs/` directory

Both `miroir-server` and the Vite dev server read certificates from the same location: `<repo-root>/certs/`.  This is computed at runtime relative to each package's `__dirname`:

| Package | `__dirname` | Default path to `certs/` |
|---|---|---|
| `miroir-server/src/server.ts` | `.../packages/miroir-server/src` | `../../../certs` |
| `miroir-standalone-app/vite.config.js` | `.../packages/miroir-standalone-app` | `../../certs` |
| `miroir-standalone-app-electron/src/main.ts` | `.../packages/miroir-standalone-app-electron/src` | `../../../certs` |

Certificate paths can be overridden via `MIROIR_TLS_CERT` and `MIROIR_TLS_KEY` environment variables (useful for production deployments).

The `certs/` directory is **gitignored** (cert files matched by `certs/*.pem` / `certs/*.key` in `.gitignore`).  A `certs/README.md` is checked in to preserve the empty directory in git.

---

## Graceful HTTP fallback

All three entry points (server, Vite, Electron) check whether the certificate files exist before enabling HTTPS.  If certificates are absent, they silently fall back to plain HTTP with a console warning.

This ensures:
- New developers can clone and run the project before generating certificates.
- CI environments that do not need HTTPS continue to work without modification.
- The fallback is explicit and visible (console warning) rather than silent.

**Logic (pseudo-code, same pattern in all three files):**

```
certsReady = existsSync(certFile) && existsSync(keyFile)
if certsReady:
    serve over HTTPS using cert/key
else:
    warn "run setup-https to enable HTTPS"
    serve over HTTP
```

---

## Vite proxy and `secure: false`

The Vite dev server acts as a HTTP/HTTPS reverse proxy for API routes (`/query`, `/action`, `/CRUD`, `/queryTemplate`), forwarding them to `miroir-server`.

When the server runs over HTTPS, the Vite proxy must also speak HTTPS to the server.  The proxy option `secure: false` tells Vite's internal `http-proxy` not to perform certificate verification for upstream connections.

**Why `secure: false` instead of `NODE_EXTRA_CA_CERTS`?**
- Setting `secure: false` is self-contained inside `vite.config.js` — no shell profile dependency.
- `NODE_EXTRA_CA_CERTS` is still required for other Node.js processes (e.g., the test runner), so it must be set anyway; adding it as a dep for the proxy too would create an order-of-operations issue in the dev workflow.
- The `secure: false` applies **only** to the Vite proxy's upstream connection to localhost — it does not affect the browser-facing HTTPS connection.

---

## Electron: dev vs production

| Mode | URL loaded | TLS required |
|---|---|---|
| Development | `https://localhost:5173/home` (or `http://` fallback) | mkcert CA in OS trust store |
| Production | `app://miroir/home` (custom Electron protocol, serves bundled files) | None — `app://` is a local protocol |

The production Electron build uses a custom `app://` scheme registered with `protocol.registerSchemesAsPrivileged`.  It serves the statically built frontend directly from disk through Electron's `net.createConnection`, completely bypassing HTTP/HTTPS.  **No TLS configuration changes are needed for production Electron builds.**

---

## Production deployment strategies

### Option A — Reverse proxy (recommended for public deployments)

```
Internet → Caddy/nginx (TLS termination, real cert) → localhost:3080 (plain HTTP)
```

Caddy automatically provisions and renews Let's Encrypt certificates.  Express runs on plain HTTP internally with no TLS code.  CORS origins are updated to the production domain.

**Advantages:**
- Automatic cert renewal (Let's Encrypt via Caddy ACME).
- No TLS code in the application layer.
- Standard pattern for containerised deployments.

### Option B — Direct TLS in Express

```
Internet → Express HTTPS server on port 3080 (real cert via env vars)
```

Set `MIROIR_TLS_CERT` and `MIROIR_TLS_KEY` to production certificate paths (e.g., Let's Encrypt via certbot, or a commercial CA).

**Advantages:**
- Simpler infrastructure (no reverse proxy needed).
- One fewer moving part for small deployments.

**Trade-off:** Manual cert renewal unless scripted, or using a cert manager.

---

## Files changed in this migration

| File | Change |
|---|---|
| `packages/miroir-server/src/server.ts` | Added `https` import; replaced `app.listen()` with `https.createServer()` + HTTP fallback; updated CORS origins to `https://` |
| `packages/miroir-server/config/miroirConfig.server.json` | `rootApiUrl` `http://` → `https://` |
| `packages/miroir-standalone-app/vite.config.js` | Added `fs`/`url` imports; computed cert paths; added `server.https`; updated 4 proxy targets to HTTPS with `secure: false` |
| `packages/miroir-standalone-app-electron/src/main.ts` | Compute `_certsReady` at startup; use `https://localhost:5173` when certs present |
| `packages/miroir-standalone-app-electron/src/ipcServerSetup.ts` | Updated 2 in-process placeholder URLs to `https://` |
| `packages/miroir-standalone-app-electron/app.config.json` | `webAppUrl` `http://` → `https://` |
| `packages/miroir-standalone-app-electron/start-dev.sh` | Health-check migrated to `https://` with `-k` flag (+ HTTP fallback) |
| `packages/miroir-standalone-app/tests/miroirConfig.test-*.json` (17 files) | `rootApiUrl` `http://` → `https://` |
| `packages/miroir-test-app_deployment-library/scripts/extractMetaModelConfig.json` | `rootApiUrl` `http://` → `https://` |
| `.gitignore` | Added `certs/*.pem` and `certs/*.key` exclusion rules |
| `certs/README.md` | New — documents the gitignored certs directory |
| `scripts/setup-https.sh` | New — mkcert setup script (bash) |
| `scripts/setup-https.ps1` | New — mkcert setup script (PowerShell) |
| `docs/guides/https-setup-developer.md` | New — developer HTTPS setup guide |
| `docs/guides/https-setup-user.md` | New — user installation and deployment guide |
| `docs/reference/https-architecture.md` | This file |
